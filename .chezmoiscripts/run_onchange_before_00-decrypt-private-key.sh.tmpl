#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR: ${0##*/} failed at line $LINENO" >&2' ERR

# {{ include "key.txt.age" | sha256sum }}
KEY_FILE="{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"
mkdir -p "$(dirname "$KEY_FILE")"

if [ -n "${AGE_SECRET_KEY:-}" ]; then
    echo "Restoring age key from AGE_SECRET_KEY environment variable..."
    echo "${AGE_SECRET_KEY}" > "$KEY_FILE"
elif [ ! -t 0 ]; then
    echo "ERROR: AGE_SECRET_KEY is not set and no TTY is available for passphrase entry." >&2
    echo "Set AGE_SECRET_KEY for non-interactive bootstrap runs." >&2
    exit 1
else
    "{{ .chezmoi.executable }}" age decrypt --output "$KEY_FILE" --passphrase "{{ .chezmoi.sourceDir }}/key.txt.age"
fi

chmod 600 "$KEY_FILE"
