#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR: ${0##*/} failed at line $LINENO" >&2' ERR

echo "üöÄ Starting initial environment setup..."

{{ if eq .chezmoi.os "darwin" }}

if ! command -v /opt/homebrew/bin/brew > /dev/null 2>&1; then
    echo "üì¶ Installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo "‚úÖ Homebrew already installed."
fi

{{ else if eq .chezmoi.os "linux" }}

run_privileged() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    elif command -v sudo > /dev/null 2>&1; then
        sudo "$@"
    else
        echo "ERROR: sudo is required when not running as root." >&2
        exit 1
    fi
}

retry() {
    local attempts="$1"
    shift
    local n=1
    while ! "$@"; do
        if [ "$n" -ge "$attempts" ]; then
            return 1
        fi
        n=$((n + 1))
        echo "Retrying command ($n/$attempts): $*"
        sleep 2
    done
}

is_container() {
    [ -f /.dockerenv ] || [ -f /run/.containerenv ] || grep -qaE '(docker|containerd|kubepods|lxc)' /proc/1/cgroup 2>/dev/null
}

if command -v git > /dev/null 2>&1 && command -v fish > /dev/null 2>&1 && command -v curl > /dev/null 2>&1; then
    echo "‚úÖ Essential packages already installed."
else
    echo "üì¶ Installing essential packages..."
    {{ if (or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu")) }}
    export DEBIAN_FRONTEND=noninteractive
    retry 3 run_privileged apt-get update
    retry 3 run_privileged apt-get install -y curl ca-certificates git fish
    {{ else if eq .chezmoi.osRelease.id "fedora" }}
    run_privileged dnf -y install curl ca-certificates git fish
    {{ else if eq .chezmoi.osRelease.id "arch" }}
    run_privileged pacman -Syu --noconfirm curl ca-certificates git fish
    {{ else }}
    echo "ERROR: Unsupported Linux distribution: {{ .chezmoi.osRelease.id }}" >&2
    exit 1
    {{ end }}
fi

if ! command -v mise > /dev/null 2>&1 && [ ! -x "{{ .chezmoi.homeDir }}/.local/bin/mise" ]; then
    echo "üì¶ Installing Mise..."
    curl --fail --location --retry 5 --retry-all-errors --connect-timeout 10 https://mise.run | sh
else
    echo "‚úÖ Mise already installed."
fi

FISH_PATH="$(command -v fish)"
if is_container; then
    echo "‚ÑπÔ∏è Container environment detected; skipping default shell change."
elif [ "${SHELL:-}" != "$FISH_PATH" ]; then
    if [ -t 0 ] && command -v chsh > /dev/null 2>&1; then
        echo "üîÑ Setting Fish as the default shell..."
        if ! grep -q "$FISH_PATH" /etc/shells; then
            printf '%s\n' "$FISH_PATH" | run_privileged tee -a /etc/shells > /dev/null
        fi
        TARGET_USER="${USER:-$(id -un)}"
        if chsh -s "$FISH_PATH" "$TARGET_USER"; then
            echo "‚úÖ Default shell changed to Fish."
        else
            echo "‚ö†Ô∏è Could not change default shell automatically."
        fi
    else
        echo "‚ÑπÔ∏è Skipping default shell change (non-interactive environment)."
    fi
else
    echo "‚úÖ Fish is already the default shell."
fi

{{ end }}

echo "‚úÖ Initial setup complete!"
