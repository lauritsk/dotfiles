#!/usr/bin/env bash
set -euo pipefail

echo "ðŸš€ Starting initial environment setup..."

{{ if eq .chezmoi.os "darwin" }}

if ! command -v /opt/homebrew/bin/brew > /dev/null 2>&1; then
    echo "ðŸ“¦ Installing Homebrew..."
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo "âœ… Homebrew already installed."
fi

{{ else if eq .chezmoi.os "linux" }}

if ! command -v mise > /dev/null 2>&1; then
    echo "ðŸ“¦ Installing Mise..."
    curl https://mise.run | sh
else
    echo "âœ… Mise already installed."
fi

{{ if eq .chezmoi.osRelease.id "fedora" }}

if ! command -v fish > /dev/null 2>&1; then
    echo "ðŸ“¦ Installing Fish..."
    sudo dnf -y install fish
else
    echo "âœ… Fish already installed."
fi

{{ else if eq .chezmoi.osRelease.idLike "debian" }}

if ! command -v fish > /dev/null 2>&1; then
    echo "ðŸ“¦ Installing Fish..."
    sudo apt -y install fish
else
    echo "âœ… Fish already installed."
fi

{{ else if eq .chezmoi.osRelease.idLike "arch" }}

if ! command -v fish > /dev/null 2>&1; then
    echo "ðŸ“¦ Installing Fish..."
    sudo pacman -S --noconfirm fish && sudo chsh -s $(which fish) $USER
else
    echo "âœ… Fish already installed."
fi

{{ end }}

if [ "$SHELL" != "$(command -v fish)" ]; then
    echo "ðŸ”„ Setting Fish as the default shell..."
    if ! grep -q "$(command -v fish)" /etc/shells; then
        command -v fish | sudo tee -a /etc/shells
    fi
    sudo chsh -s "$(command -v fish)" "$USER"
    echo "âœ… Default shell changed to Fish."
else
    echo "âœ… Fish is already the default shell."
fi

{{ end }}

echo "âœ… Initial setup complete!"
