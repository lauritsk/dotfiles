#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR: ${0##*/} failed at line $LINENO" >&2' ERR

echo "üöÄ Starting package sync..."

{{ if eq .chezmoi.os "darwin" }}

# {{ include "dot_Brewfile" | sha256sum }}
if command -v /opt/homebrew/bin/brew > /dev/null 2>&1; then
    echo "üîÑ Syncing Homebrew packages..."
    eval "$(/opt/homebrew/bin/brew shellenv bash)"
    if brew bundle check --global > /dev/null 2>&1; then
        echo "‚úÖ Homebrew bundle already satisfied."
    else
        brew bundle --global --no-upgrade
        echo "‚úÖ Homebrew packages synced."
    fi
else
    echo "‚ùå Homebrew command not found..."
    exit 1
fi

{{ else if eq .chezmoi.os "linux" }}

# {{ include "private_dot_config/mise/mise.lock" | sha256sum }}
MISE_BIN="$(command -v mise || true)"
if [ -z "$MISE_BIN" ] && [ -x "{{ .chezmoi.homeDir }}/.local/bin/mise" ]; then
    MISE_BIN="{{ .chezmoi.homeDir }}/.local/bin/mise"
fi

if [ -z "$MISE_BIN" ]; then
    echo "üì¶ Mise not found; installing..."
    curl --fail --location --retry 5 --retry-all-errors --connect-timeout 10 https://mise.run | sh
    MISE_BIN="$(command -v mise || true)"
    if [ -z "$MISE_BIN" ] && [ -x "{{ .chezmoi.homeDir }}/.local/bin/mise" ]; then
        MISE_BIN="{{ .chezmoi.homeDir }}/.local/bin/mise"
    fi
fi

if [ -n "$MISE_BIN" ]; then
    echo "üîÑ Syncing Mise packages..."
    if "$MISE_BIN" install --dry-run-code --quiet > /dev/null 2>&1; then
        echo "‚úÖ Mise tools already satisfied."
    else
        echo "Installing tools using mise..."
        "$MISE_BIN" install
    fi
    echo "‚úÖ Mise packages synced."
else
    echo "‚ùå Mise command not found (checked PATH and {{ .chezmoi.homeDir }}/.local/bin/mise)."
    exit 1
fi

{{ end }}

echo "‚úÖ Package sync complete!"
