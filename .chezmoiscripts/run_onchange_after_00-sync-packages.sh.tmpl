#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR: ${0##*/} failed at line $LINENO" >&2' ERR

echo "ğŸš€ Starting package sync..."

{{ if eq .chezmoi.os "darwin" }}

# {{ include "dot_Brewfile" | sha256sum }}
if command -v /opt/homebrew/bin/brew > /dev/null 2>&1; then
    echo "ğŸ”„ Syncing Homebrew packages..."
    eval "$(/opt/homebrew/bin/brew shellenv bash)"
    if brew bundle check --global > /dev/null 2>&1; then
        echo "âœ… Homebrew bundle already satisfied."
    else
        brew bundle --global --no-upgrade
        echo "âœ… Homebrew packages synced."
    fi
else
    echo "âŒ Homebrew command not found..."
    exit 1
fi

{{ else if eq .chezmoi.os "linux" }}

# {{ include "private_dot_config/mise/mise.lock" | sha256sum }}
if command -v {{ .chezmoi.homeDir}}/.local/bin/mise > /dev/null 2>&1; then
    echo "ğŸ”„ Syncing Mise packages..."
    eval "$(~/.local/bin/mise activate bash)"
    if ! mise install --dry-run-code --quiet; then
        echo "Installing stuff using mise"
        mise install
    fi
    echo "âœ… Mise packages synced."
else
    echo "âŒ Mise command not found..."
    exit 1
fi

{{ end }}

echo "âœ… Package sync complete!"
